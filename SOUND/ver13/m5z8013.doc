

	ＭＥＧＡ　ＤＲＩＶＥ　Ｚ８０　ＳＯＵＮＤ　ＦＩＬＥ
				ＶＥＲ　１．３　ＭＡＮＵＡＬ

				１９８９．５．９	Ｔ．Ｕｗａｂｏ


	１：概要
	２：ＦＩＬＥ
	３：データ形式の変更
	４：ＷＯＲＫ　ＲＡＭ
	５：バンク設定の方法
	６：ＰＡＵＳＥについて
	７：フェイドアウトについて
	８：音色データのＳＥＴについて
	９：注意




１：概要

	つぎのディレクトリ構成を作って下さい。
	
		<m5>
		|----------------------
		|		|
		<z80>	      <loader>
		|
		-----------------------
		|        |          |
		<fmk>   <ver13>　　<prj>


	つぎのようにして、プロジェクトディレクトリおよび
	プロジェクトファイルを作ります。
		1　＜ｆｍｋ＞のディレクトリにはいり
		2　ｆｍｋ　＜プロジェクト名（３，４文字）＞と入力する。
		
	作業には、ＴＯＯＬＳ１ー２ー３（ＡＳＣＩＩ） が必要です。

	プロジェクトファイルのアセンブル、リンクには、＜ＰＲＪ＞．ＢＡＴを
	起動して行います。ＭＳ−ＤＯＳのＭＡＫＥ．ＥＸＥを使用して、履歴の
	管理をしています。ＴＯＯＬＳにも　ＭＡＫＥがあるので、そちらが起動
	しないように、ＰＡＴＨはＭＳ−ＤＯＳのシステムのディレクトリが先に
	来るようにします。
	
	実行ファイルは、
	＜ＰＲＪ＞ＣＮＴ．ＨＥＸ　　　（アドレス　0000h　から）
	＜ＰＲＪ＞ＳＥ．ＨＥＸ　　　　（アドレス　1000h以降任意）
	＜ＰＲＪ＞ＢＮＫ．ＨＥＸ　　　（アドレス　8000h　から）
	＜ＰＲＪ＞ＳＮＧ．ＨＥＸ　　　（アドレス　1000h以降任意）
	の４つできます。
	　
	＜ＰＲＪ＞ＳＮＧ．ＨＥＸ　は、１曲だけをアセンブル、リンク
	するものです。リンク時にエラーがでますが、構いません。それが
	嫌な場合、ダミーのラベルを持つことで解決できます。しかし、そ
	のままでは、全曲をリンクして＜ＰＲＪ＞ＢＮＫ．ＨＥＸを作る場
	合にＭＵＬＴＩ　ＤＩＦＩＮＤ　ＥＲＲＯＲが起きるので、マクロ
	のＩＦ文でとりはずしできるようにしておくことが必要です。
	
	＜ＰＲＪ＞ＳＮＧ．ＨＥＸのスタートアドレスは、＜ＰＲＪ＞．Ｌ
	ＮＫというリンクファイル内で与えています。Ｐ：１３００　がそ
	れです。この場合、スタートアドレスが１３００Ｈとしてリンクし
	ます。このときＺ８０メモリの　１Ｃ０２Ｈ　＝　００Ｈ
	１Ｃ０３Ｈ　＝　１３Ｈ　とします。
	　（ＷＯＲＤで　１３００Ｈ。サウンドコントロールは、このアド
	レスを参照して、曲、Ｓ．Ｅ、ＥＮＶＥ、ＶＩＢＲ等のデータアド
	レスを得る。また、エディタも同様である。）
	　また、１Ｃ００Ｈ以降は、プログラムのＷＯＲＫ　ＲＡＭなので、
	＜ＰＲＪ＞ＳＮＧ．ＨＥＸは、１ＢＦＦＨに納める必要があります。
	
	
	＜ＰＲＪ＞ＳＥ．ＨＥＸ　は、ＳＥデータをリンクしたものです。
	スタートアドレスは　＜ＰＲＪ＞．ＭＫＦのＬＮＫコマンドで与えて
	います。このスタートアドレスは、＜ＰＲＪ＞ＴＢ．ＬＩＢで
	setop_adr	equ	1000h
	として、プログラムに与えます。＜ＰＲＪ＞ＴＢ．ＳＲＣの
	ADDRTB:: の６ＢＹＴＥ目の
		dw  	setop_adr
	に反映されます。サウンドコントロールプログラムおよびエディタ
	は、このテーブルからＳ．Ｅのアドレスを知ることができます。
	　このテーブルは、＜ＰＲＪ＞ＳＮＧ．ＨＥＸのスタートアドレス＋
	６です。（＜ＰＲＪ＞ＴＢ．ＳＲＣは、＜ＰＲＪ＞ＳＮＧ．ＨＥＸ
	のＴＯＰにリンクされている。）

	＜ＰＲＪ＞ＢＮＫ．ＨＥＸは、ソングデータ等、Ｍｅｇａ　Ｄｒｉｖｅ
	のバンクエリア（カートリッジ）からＺ８０がよみだすデータをリンク
	してつくります。スタートアドレス及びリンクするファイル名は、ＡＬＬ
	．ＬＮＫファイルで与えます。このデータで曲を鳴らしたいときは、
	１Ｃ０２Ｈ、１Ｃ０３Ｈにデータスタートアドレスを書き込んでおきます。
	通常８０００Ｈ（バンクトップをスタートアドレスとします。
	　Ｓ．Ｅのデータが多く１ＢＦＦＨまでに納まらない場合、ソングデータ
	とリンクしバンクデータとします。この場合　ADDRTB:: の６ＢＹＴＥ目の
		dw  	setop_adr
	を、	dw	setb##
	とすればスムーズにはこびます。
	　ただし　エディタは、現在００００Ｈから１ＦＦＦＨ（Ｚ８０　ＳＲＡＭ
	エリア）にあるデータしか表示できません。ＲＡＭボード、またはＲＯＭ＿
	ＲＡＭボードを使用することで解決できます。ただし、エディタルーチンの
	修正が要）


	　アセンブル、リンクを終了すると、ＩＣＥに入ります。
	ＩＣＥに入らない場合、１度エディタをＦＬＡＧ　ＭＯＤＥ画面に切り替え
	て、メニュー画面に戻してください。（ＳＴＡＲＴ　ボタンで戻る）
	ＩＣＥのプロンプトがでている状態で
		ＳＥＴＵＰ　
	と入力すると、ＩＣＥのマッピングをし、ＲＡＭの初期設定をし、
	＜ＰＲＪ＞ＣＮＴ．ＨＥＸ　　　（アドレス　0000h　から）
	＜ＰＲＪ＞ＳＥ．ＨＥＸ　　　　（アドレス　1000h以降任意）
	＜ＰＲＪ＞ＳＮＧ．ＨＥＸ　　　（アドレス　1000h以降任意）
	をロードします。
	＜ＰＲＪ＞ＢＮＫ．ＨＥＸ　　　（アドレス　8000h　から）
	をロードしたい場合　ＢＮＫと入力します。
	こういったＩＣＥのマクロは、＜ＰＲＪ＞Ｚ．ＭＡＣに登録して
	あります。
	
	Ｇ　０で実行します。






２：ｆｉｌｅ

	m5int13.src		インタラプト制御ルーチン
			include m5eq13.lib

	m5cnt13.src		サウンドコントロール
			include M5EQ13.LIB
			include	M5mcr13.lib

	m5cmd13.src		コマンドコントロール
			include M5EQ13.LIB
			include	M5mcr13.lib

	m5fmdr13.src		リズムコントロール
			include	m5eq13.lib
			include	M5mcr13.lib

	m5psg13.src		ＰＳＧコントロール
			include	m5eq13.lib

	m5tb13.src		ＥＮＶＥ，ＶＩＢＲ，プライオリティテーブル
			include	m5eq13.lib

	m5setb13.src		Ｓ．Ｅアドレステーブル
			included in m5se13.s

	m5eq13.lib		アサイン
	m5eqtb.lib		アサイン

	m5mcr13.lib		マクロ

	m513.bat		ＢＡＴ

	m513.mkf		ＭＡＫＥファイル

	M513.LNK		M5SNG.HEX　作成用リンクファイル
	ALL.LNK			M5BNK.HEX　作成用リンクファイル

	m5se13.s		Ｓ．Ｅデータファイル
	m5sng113.s		ＳＯＮＧデータファイル　Ｓ８１
	m5sng213.s		ＳＯＮＧデータファイル　Ｓ８２
	m5sng313.s		ＳＯＮＧデータファイル　Ｓ８３
	m5sng413.s		ＳＯＮＧデータファイル　Ｓ８４
	m5sng513.s		ＳＯＮＧデータファイル　Ｓ８５
	m5sng613.s		ＳＯＮＧデータファイル　Ｓ８６
	m5sng713.s		ＳＯＮＧデータファイル　Ｓ８７
	m5sng813.s		ＳＯＮＧデータファイル　Ｓ８８
	m5sng913.s		ＳＯＮＧデータファイル　Ｓ８９
	m5snga13.s		ＳＯＮＧデータファイル　Ｓ８Ａ
	m5sngb13.s		ＳＯＮＧデータファイル　Ｓ８Ｂ
	m5sngc13.s		ＳＯＮＧデータファイル　Ｓ８Ｃ
	m5sngd13.s		ＳＯＮＧデータファイル　Ｓ８Ｄ
	m5snge13.s		ＳＯＮＧデータファイル　Ｓ８Ｅ
	m5sngf13.s		ＳＯＮＧデータファイル　Ｓ８Ｆ

	m5cnt.hhh		s-ram prg & data
	m5sng.hhh		bank data
	m5se.hhh		s.e data


	実行ファイル
	m5cnt.hex 
		 M5INT,M5CNT,M5FMDR,M5CMD,M5PSG,M5SE をリンクしてできる。
		0000H  からＳＴＡＹする。

	M5BNK.HEX
		M5TB,とソングファイルをリンクしてできる。
		8000H  からＳＴＡＹする。

	M5SNG.HEX
		M5TB,とソングファイル１つをリンクしてできる。
		1000H  からＳＴＡＹする。
		但し 1BFFH を越えてはいけない。

	Ｍ５ＢＮＫ．ＨＥＸ　Ｍ５ＳＮＧ．ＨＥＸ

	　データスタートオフセット値指定ＷＯＲＫ　(1C02H,1C03H) にアドレスを
	いれる。
		M5BNK.HEX  (8000H) : 1C02 = 0  / 1C03 = 80H
		M5SNG.HEX  (1000H) : 1C02 = 0  / 1C03 = 10H

	エディタは、Ｍ５ＳＮＧ．ＨＥＸのデータを表示する。



３：データ形式の変更
	ａ：１曲づつのファィルをもつ。そこに、ヘッダーデータ、音色データ
	　　ｓｏｎｇデータをもつ。
	ｂ：ヘッダーのデータフォーマットを以下の例のように変える。
	　注意）　２行目で指定するチャンネル数とヘッダーの数は
		一致していること。
		　リズムを使用せずＦＭ６ＣＨすべてをトーンに使用する場合
		チャンネル数を７にし、リズムテーブルをＣＭＥＮＤにする。
		Ｓ．ＥとＳＯＮＧのフォーマットが違うので注意。

	ｃ：音色データは、例のようにレジスタデータを省いたものとする。



	S81::
		DW	TIMB81				; VOICE TOP ADDR.
	
		DB	6,2,TP81,DL81			; FM CHIAN,PSG,CHIAN
	
		DEFW	TAB81D				; rythm table pointer
		DEFB	0,FA81D				; bias,volm
	
		DEFW	TAB810
		DEFB	FB81M,FA81M
	
		DEFW	TAB811
		DEFB	FB81B,FA81B
	
		DEFW	TAB812
		DEFB	FB81K1,FA81K1
	
		DEFW	TAB813
		DEFB	FB81K2,FA81K2
	
		DEFW	TAB814
		DEFB	FB81K3,FA81K3
	
		DEFW	TAB810P
		DEFB	PB81M,PA81M,PV81M,PE81M
	
		DEFW	TAB811P
		DEFB	PB81B,PA81B,PV81B,PE81B
	
	;	DEFW	TAB812P
	;	DEFB	PB81K,PA81K,PV81K,PE81K
	
	TAB810::
	
	
	
	
	
	TIMB81::
	;---------------- FM VOICE DATA -------------------
	fev8100::
		CNF	4,5			; Algo, Feed Back
		TL	22,0,18,0		; total level
		MD	2,7,2,7,2,6,2,6		; multiple,ditune
		RSAR	0,31,0,23,0,31,0,31	; key scale,attack rate
		D1R	12,15,10,13		; decay
		D2R	0,6,0,6 		; sustin rate
		RRL	15,9,15,3,15,9,15,7	; release rate,sustine lavel
	
	fev8101::
		;---------------<: bass >---------------
		CNF	2,3*2+1
		TL	20h,20h,20H,00H
		MD	4,0,2,0,8,0,4,0
		RSAR	0,31,0,31,0,31,0,31
		D1R	16,15,9,8
		D2R	7,0,0,0
		RRL	15,3,15,0,15,0,15,4






	Ｓ．Ｅの例

	チャンネルナンバー　０から６（３は除く）は、ＦＭ、
	８０Ｈ、０Ａ０Ｈ、０Ｃ０Ｈは　ＰＳＧ１、２、３チャンネル。
	

	;********************************
	; 　DOOR
	;********************************
	S91::
	
		DW	TIMB91		; VOICE TOP ADDR.
	
		db	1,2			; base,use chian no
	
		DB	0A0H,06H		; FLAG,CHIAN
		DW	TAB910P			; FM 1ch table pointer
		DEFB	000H,000H	 	; bias,volm
	
		DB	0A8H,0C0H		; FLAG,CHIAN
		DW	TAB911P			; FM 1ch table pointer
		DEFB	000H,004H	 	; bias,volm
	
	TAB910P::
		DB	FEV,0
		DB	93H,10H,3
		DB	93H,0E0H,10
		DB	CMEND
	TAB911P::
		db	CMNOIS,7
		DB	0,10H,1,3
		DB	0,013H,10H,10
		DB	CMEND
	
	TIMB91::
		CNF	2,6*2
		MD	0,2,2,6,4,2,1,2
		RSAR	0,27,0,20,0,25,0,21
		D1R	16,8,17,16
		D2R	0,16,14,7
		RRL	15,7,15,6,15,5,15,5
		TL	0,4,27,0
	
	
	
	




４：ＷＯＲＫ　ＲＡＭ
	つぎのように割り当てている。
	
	TB20CH	EQU	0	     	; RYTHM FMCH 2	01C30H
	TB21CH	EQU	TB20CH+FLGVOL	; SONG  FMCH 0	01C60H
	TB22CH	EQU	TB21CH+FLGVOL	; SONG  FMCH 1	01C90H
	TB23CH	EQU	TB22CH+FLGVOL	; SONG  FMCH 4	01CC0H
	TB24CH	EQU	TB23CH+FLGVOL	; SONG  FMCH 5	01CF0H
	TB25CH	EQU	TB24CH+FLGVOL	; SONG  FMCH 6	01D20H
	TB26CH	EQU	TB25CH+FLGVOL	; RYTHM WORK	01D50H
	TB27CH	EQU	TB26CH+FLGVOL	; PSG CH 0	01D80H
	TB28CH	EQU	TB27CH+FLGVOL	; PSG CH 1	01DB0H
	TB29CH	EQU	TB28CH+FLGVOL	; PSG CH 2	01DE0H
	TB2ACH	EQU	TB29CH+FLGVOL	; BACK S.E FCH5	01E10H
	TB2BCH	EQU	TB2ACH+FLGVOL	; BACK S.E FCH6	01E40H
	TB2CCH	EQU	TB2BCH+FLGVOL	; S.E CH 2	01E70H
	TB2DCH	EQU	TB2CCH+FLGVOL	; S.E CH 5	01EA0H
	TB2ECH	EQU	TB2DCH+FLGVOL	; S.E CH 6	01ED0H
	TB2FCH	EQU	TB2ECH+FLGVOL	; S.E PSG CH 0	01F00H
	TB30CH	EQU	TB2FCH+FLGVOL	; S.E PSG CH 1	01F30H
	TB31CH	EQU	TB30CH+FLGVOL	; S.E PSG CH 2	01F60H




５：バンク設定の方法


	Ｚ８０をＧ０するまえに　ＢＡＮＫアドレス、およびデータスタート
	オフセット値をＺ８０がわにあたえて下さい。

　　ＢＡＮＫアドレス
		0a01c00h  ==> ＢＩＴ　１６−２３
		0a01c01h  ==> ＢＩＴ　８−１５

		ＥＸ．　ＢＡＮＫが　３８０００Ｈのとき
	;---------------------;
	;   1c00H   ;  1c01   ;
	;---------------------;
	;      3    ;   80    ;
	;---------------------;

		BANKHI		EQU	1c00H		; HI BYTE
		BANKLOW		EQU	1c01H		; LOW BYTE

　　データスタートオフセット値　（８０００ｈ）
	;---------------------;
	;   1c02H   ;  1c03   ;
	;---------------------;
	;      00   ;   80    ;
	;---------------------;


６：ＰＡＵＳＥについて
	ＰＡＵＳＥのセット
	　　　　pause_fl (0a01c0bh)  に１をセットする。
	ＰＡＵＳＥの解除
	　　　　pause_fl に　８０Ｈをセットする。

７：フェイドアウトについて
	　ｋｙｆｌａｇに　ｅ０ｈをセットすると、フェイドアウトかが
	かかります。
	　フェイドアウトのスピードおよびＶＯＬＭのレベルを任意に
	指定したいときは次のようにしてください。
	　ａ：現在のｖｏｌｍより何段階ｖｏｌｍを落としたいかを
	      FOUTF(0a01c08h) にいれる。範囲は　１から７ｆｈ。ただし
	      ｂｉｔ７をたてること。
	  ｂ：ｖｏｌｍを１段階落とすのに、何インタラプトかけるかを
		FOUTTM_STR(0a01c09h),FOUTTM(0a01c0ah) にいれる。

	フェイドアウトタイムは、　ａ＊ｂ＊１６ｍｓｅｃとなる。


８：音色データのＳＥＴについて

	FMREG_TB
	FMREG_RRTB	,,,リリースのレジスタテーブル
	fmreg_tl_tb	,,,トータルレベルのレジスタテーブル

	ＦＭデータはレジスタを省略した形でもっているため
	上記のテーブルよりレジスタを参照し,ＳＥＴしている。
	トータルレベルは キャリアにｂｉｔ７を立てることによってＶｏｌｍ
	を変化させるレジスタを判別する。
	また,キャリアのｂｉｔ７を立てることはマクロによっておこなって
	いるため,ＦＭデータを直値で与える場合は,各自でキャリアのｂｉｔ７
	を立てるか,キャリアの値をアサインで持っておく必要がある。


９：注意：
	１：	ＣＭＮＩＯＩＳ、＜ｎｏｉｓ　ｎｏ．＞
				０Ｅ０Ｈ　−　０Ｅ７Ｈ

	２：	ＴＯＮＥ　ＭＯＤＥ　ＰＯＲＴＭＥＮＴ

			ＮＯＴＥ，ＡＤＤ　ＤＡＴＡ，ＬＥＮＧＴＨ
	３：　　ＦＭ　ＶＯＩＣＥ
		ＴＬ　が一番後ろ。　キャリアのＢＩＴ　７をたてる。
		ＬＲ　データは、ＣＵＴし、２５ＢＹＴＥＳ。

	４：　　ＢＡＣＫ　Ｓ．Ｅで　ＣＨＩＡＮＮＥＬ　が　１
	　　　　以下のものが鳴っているとき、ＢＡＣＫ　ＳＥ　ＣＬＥＡＲ
		をしてはだめ。
	
	５：　　Ｓ．ＥでＣＨＩＡＮＮＥＬ　が　１　以下のものを鳴しては
		いけない。ＥＮＤコマンドでミスる。


	６：	タイマーのサホ゜ート

	７：	ｗｏｗコマンドのサポート　
		（ただし、ｓｓｇエンベロープと共に使用できない。）

	８：	ｓｓｇエンベロープコマンドのサポート　
		（ただし、ＲＡＭの都合上　ｗｏｗ、ＣＭＮＯＩＳと共に使用
		　できない。）


