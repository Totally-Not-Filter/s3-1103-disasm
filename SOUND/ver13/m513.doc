;********************************************************
;*		$$$.doc	   ( SOUND DOCUMENT FILE )	*
;*  			ORG. M513.DOC               	*
;*		'SOUND-SORCE'                           *
;*		 for Mega Drive (Z80)			*
;*			VER  1.31/1989.12.10		*
;*				BY        T.Uwabo       *
;********************************************************


０：データのメモリ配置およびＺ８０Ｓ＿ＲＡＭの初期値について
１：リクエスト　ナンバー
２：ファイルについて
３：ＢＡＮＫのＳＥＬＥＣＴ　について
４：データトップアドレスの与え方
５：Ｚ８０へのプログラムの転送
６：ＰＡＵＳＥについて
７：フェイドアウトについて
８：ＴＩＭＥＲ
９：ＯＳ－９とのファイル受渡し
１０:　　ＶＥＲ１．３１での変更点


０：データのメモリ配置およびＺ８０Ｓ＿ＲＡＭの初期値について

	データのメモリ配置

	　Ｓ．ＥのデータをＺ８０　Ｓ＿ＲＡＭ側に、曲データは、バンクエリア
	に配置します。


				　　　ＦＩＬＥ　ＮＡＭＥ
0A00000H RDDDDDDDDDDDDDDDDDDV
 	 F SOUND PROG       F  ------ $$$CNT.HHH
0A01000H F----------------- F
	 F S.E  DATA        F  ------ $$$se.HHH
         F----------------- F
         F                  F
	 F                  F
         F                  F
         F                  F
BANK     F------------------F
         F TABLE DATA &     F  ------ $$$bnk.HHH
         F   SONG DATA      F
         F                  F
         F                  F
         F                  F
         ZDDDDDDDDDDDDDDDDDD^






	Ｚ８０Ｓ＿ＲＡＭの初期値について


	　Ｚ８０チップをリセットスタートさせる前に、０Ａ０１Ｃ００Ｈから
	１０ＢＹＴＥＳを、つぎのようにイニシャライズしてください。
	
	0A01C00H
		XX   XX   00   80   B4   00    E6      80      00       00 
	　	|         |         |	       |       |       |        |
		BANK     DATA START TIMER A   TIMER B  TIMER   NO USE   KYFLAG
		ADDR.(2)  ADDR.(2)    (2)      (1)     FLAG(1)    (1)    (1)

	BANK ADDR　：　バンクのアドレスをセットします。詳細は後章にて。





１：リクエスト　ナンバー

	；－－－－－　ＭＵＳＩＣ　－－－－－－

	Ｓ８１		
	Ｓ８２		
	Ｓ８３		

	；－－－－－　Ｓ．Ｅ　－－－－－－－－－
	Ｓ９０		
	Ｓ９１		
	Ｓ９２		
	Ｓ９３		

	;----------- UTLTY --------------------
	;

	Ｓ		ＦＡＩＤ　ＯＵＴ
	Ｓ		ＳＯＵＮＤ　ＣＬＥＡＲ
	Ｓ		ＰＳＧ　ＣＬＲ
	Ｓ		ＢＡＣＫ　Ｓ．Ｅ　ＣＬＥＡＲ



	リクエストナンバー　セットアドレス

	KYFLAG		EQU	0A01C0aH    (BYTE)
	BAF2		EQU	BAF1+1		;
	BAF3		EQU	BAF2+1		;



２：ファイルについて
　　　　　つぎの２つです。ＤＢ　テーブルデータになっています。
	m5BNK.HHH		; SONG DATA
	m5CNT.HHH		; SOUND CONTROL 
	m5se.hhh		; S.E DATA


	アセンブルするファイルはつぎのようにしてください。

		org   $10000	；ＢＡＮＫ　ＴＯＰ　アドレス
				；　　（８０００Ｈ　ごと）
   	include	m5bnk.hhh　　　；　このファイルが先にくること。
   	include	m5cnt.hhh
   	include	m5se.hhh

	ＢＡＮＫのトップを８０００Ｈ＊Ｎ　以外にしたいときは、
	その値を指定してください。



３：ＢＡＮＫのＳＥＬＥＣＴ　について


	Ｚ８０をＧ０するまえに　ＢＡＮＫアドレス、およびデータスタート
	オフセット値をＺ８０がわにあたえて下さい。

　　ＢＡＮＫアドレス
		0a01c00h  ==> ＢＩＴ　１６－２３
		0a01c01h  ==> ＢＩＴ　８－１５

		ＥＸ．　ＢＡＮＫが　３８０００Ｈのとき
	RDDDDDDDDDDDvDDDDDDDDDDV
	F   1c00h   F  1c01h   F
	fDDDDDDDDDDD醇DDDDDDDDDDn
	F     03h   F   80h    F
	ZDDDDDDDDDDD~DDDDDDDDDD^

		BANKHI		EQU	1c00H		; HI BYTE
		BANKLOW		EQU	1c01H		; LOW BYTE

４：データトップアドレスの与え方
	データトップアドレスとは、ｚ８０エリアから見たｓｏｎｇデータ
	のトップアドレスです。バンクのトップに置くときは、８０００ｈ
	となます。つぎのように設定して下さい。
	RDDDDDDDDDDDvDDDDDDDDDDV
	F   1c02h   F  1c03h   F
	fDDDDDDDDDDD醇DDDDDDDDDDn
	F     00h   F   80h    F	(8000h)
	ZDDDDDDDDDDD~DDDDDDDDDD^

５：Ｚ８０へのプログラムの転送
	Ａ：曲を鳴らすとき
		　２：で述べた　SRCCNT.HHHにあたるデータをＡ０００００Ｈ
		から送ります。
   		　　また、m5se.hhhを　Ａ０１０００Ｈからおくります。
		　Ｚ８０をスタートさせるまえに、３：で述べたように
		ＢＡＮＫアドレス、およびデータスタートオフセット値を
		Ｚ８０がわにあたえて下さい。
	　	　ｚ８０をスタートすると、ｋｙｆｌａｇの値はクリアします。

６：ＰＡＵＳＥについて
	ＰＡＵＳＥのセット
	　　　　pause_fl (0a01c10h)  に１をセットする。
	ＰＡＵＳＥの解除
	　　　　pause_fl に　８０Ｈをセットする。
	

７：フェイドアウトについて
	　ｋｙｆｌａｇに　ｅ０ｈをセットすると、フェイドアウトかが
	かかります。
	　フェイドアウトのスピードおよびＶＯＬＭのレベルを任意に
	指定したいときはｋｙｆｌａｇに　ｅ０ｈをセットするかわりに
	次のようにしてください。
	　ａ：現在のｖｏｌｍより何段階ｖｏｌｍを落としたいかを
	      FOUTFL(0A01C0Dh) にいれる。範囲は　１から７ｆｈ。ただし
	      ｂｉｔ７をたてること。
	  ｂ：ｖｏｌｍを１段階落とすのに、何インタラプトかけるかを
		FOUTTM_STR(0A01C0Eh-BYTE),FOUTTM(0A01C0Fh-BYTE) 
	      それぞれにいれる。

	フェイドアウトタイムは、　ａ＊ｂ＊（曲に設定したＴＩＭＥＲ値）
	となます。

	　なお、ｋｙｆｌａｇに　Ｆ８Ｈ をセットして、フェイドアウトをかけ
	ると　ａ：＝２８ｈ＋８０ｈ　、　ｂ：＝　６ｈ　が設定されます。


８：ＴＩＭＥＲ
		　このプロジェクトは、ＴＩＭＥＲ　Ａ、Ｂを使用し、サウンド
		のテンポ設定設定初期値は、
			０Ａ０１Ｃ０４Ｈ　＝　０Ｂ４Ｈ
			０Ａ０１Ｃ０５Ｈ　＝　０００Ｈ
			０Ａ０１Ｃ０６Ｈ　＝　０Ｅ６Ｈ
			０Ａ０１Ｃ０７Ｈ　＝　０８０Ｈ
			です。

		　０Ａ０１Ｃ０７Ｈは、ＳＯＵＮＤのＣＡＬＬをインタラプト
		で行うか、ＦＭのＴＩＭＥＲで行うかを決定するＦＬＡＧです。
		　０でインタラプト、４０ＨでＴＩＭＥＲ　Ｂ　使用、８０Ｈ
		でＴＩＭＥＲ　Ａ、Ｂ使用です。（ＴＩＭＥＲ　ＡでＳＯＮＧ
		のテンポ、Ｂで、Ｓ．Ｅのテンポを決める。）
		　ａ０１ｃ０４Ｈから０Ａ０１Ｃ０６Ｈまでは、ＳＯＵＮＤの
	　　　　ＦＭのＴＩＭＥＲ値のためのＷＯＲＫです。
		　マニュアルの式定数には誤りがあり、２倍の定数が正しい値
		です。したがって　ＴＩＭＥＲ　Ｂを　１６ｍｓｅｃに設定す
		るには　０Ａ０１Ｃ０６Ｈに０ＣＢＨ、８ｍｓｅｃは０Ｅ６Ｈ
		です。同様にＴＩＭＥＲ　Ａ　１６ｍｓｅｃは　０ｂ４Ｈ（
		０Ａ０１Ｃ０４Ｈに　０Ｂ４Ｈ、０Ａ０１Ｃ０５Ｈに　００Ｈ）
		となり、８ｍｓｅｃは、２５ＡＨです。
		　コマンドの使用により、ＴＩＭＥＲ＜－＞インタラプト使用
		の切り替え、ＴＩＭＥＲ使用のモード切り替え、ＴＩＭＥＲ値
		の変更が可能です。


９：ＯＳ－９とのファイル受渡し
	　ＯＳ－９は、ＣＰ／Ｍフォーマットディスクのリー／ドＷＲＩＴＥ
	が可能です。従って、デジタイザ等でフォーマットしたディスクに、
	ＦＩＬＥ　ＭＡＳＴＥＲ等でＭＳ　ＤＯＳ－＞ＣＰ／Ｍへメディア変
	換して、ファイルを書き込み、やり取りをします。



10:　　ＶＥＲ１．３１での変更点
	 旧バージョンから、つぎの点を変更しました。

	Ａ）UTLTY::　ルーチン
	Ｂ）ＧＡＴＥチエックルーチン
	Ｃ）ＢＡＦＳＣＡＮルーチン


	Ａ）UTLTY::　ルーチン
		　ｕｔｌｔｙがリクエストコードによって呼び出されたとき、
		プライオリティをクリアするようにした。
		　具体的には、m5cnt13.src ９３１行から９３２行目を挿入

	Ｂ）ＧＡＴＥチエックルーチン
		　ＧＡＴＥコマンドによるＧＡＴＥタイムの設定にたいし、
		ＤＩＳＡＢＬＥ　ＢＩＴをチエックしてＫＥＹ　ＯＦＦする
		ようにした。
		　具体的には、m5cnt13.src １２３行
			jp	z,keyoff_ch
		を
			jp	z,KEYOFF_CHK
		　とした。


	Ｃ）ＢＡＦＳＣＡＮルーチン
		　ＳＯＮＧのプライオリティチエック方法を変更しました。
		旧バージョンでは、プライオリティデータのＢＩＴ７がＯＮ
		の場合、そのリクエストコードを最優先し、他のコードをク
		リアー、なおかつプライオリティを登録しませんでした。こ
		の方法は、ＢＡＦＳＣＡＮルーチンとＫＥＹＳＣＡＮルーチ
		ンの処理が交互に行われる場合には有効です。しかし、ＶＥＲ
		１．３以降では、ＭＡＩＮでＢＡＦＳＣＡＮルーチンが絶えず
		ＣＡＬＬされ、リクエストコードバッファのチェックを行い、
		ＦＭタイマーのオーバーフロー（または、インタラプト）時の
		みＫＥＹＳＣＡＮがおこなわれます。したがってつぎのような
		タイミングでリクエストコードの書き込みが行われた場合、曲
		が鳴りません。
		
	
		ｇａｍｅ側		ｓｏｕｎｄ側
		
		曲のリクエスト		
					ｂａｆｓｃａｎルーチンで、
					プライオリティのチェック。
					リクエストコードをkyflag0
					に書き込む。

		ｓ．ｅのリクエスト
					ｂａｆｓｃａｎルーチンで、
					プライオリティのチェック。
					リクエストコードをkyflag0
					に書き込む。（曲のリクエスト
					コードは、クリアされてしまう。）
				
				ｔｉｍｅｒのｏｖｅｒ　ｆｌｏｗ
					　ｋｙｓｃａｎルーチンでkyflag0
					のリクエストコードにより、ヘッダ
					ーデータのＷＯＲＫ　ＲＡＭへの展
					開。（Ｓ．Ｅのみ鳴る。）






RAM		EQU	01C00H		;* SOUND TABLE ADDRESS 
bank_adr_top	equ	RAM
tb_adr_str	EQU	ram+2		; table data top addr store
timer_a_dt	equ	tb_adr_str+2	; 2 bytes
timer_b_dt	equ	timer_a_dt+2
timer_use_flg	equ	timer_b_dt+1	; bit 7 = a/b use  : a = song / b= s.e
					;  bit 6 only b use :
rom_seno_str	equ	ram+8		; rom se no. offset


KYFLAG0		EQU	RAM+9		;* SOUND CODE (UNDISCRIMINATE PRIORITY)
KYFLAG		EQU	KYFLAG0+1	;      //     (DISCRIMINATE PRIORITY)
BAF1		EQU	KYFLAG		;* CHOSE HIGHEST PRIORITY AMANG
BAF2		EQU	BAF1+1		;                BAF1,BAF2,&BAF3
BAF3		EQU	BAF2+1		;	AND SET IT KYFLAG
;------------ 13 ---------------
FOUTFL		EQU	BAF3+1		; FAID OUT FLAG
FOUTTM_STR	EQU	FOUTFL+1
FOUTTM		EQU	FOUTTM_STR+1	; FAID OUT TIMER
pause_fl	EQU	FOUTTM+1	; pause flg (nz: pause on)(RAM+8)
s_pause_fl	equ	pause_fl+1	; if S_PSE,ON = 1 /OFF = 0
se_mode		equ	s_pause_fl+1
RCUNT		EQU	se_mode+1		; For DLEAY COUNT NOTE LENGTH
;----------- 20 ----------------------
CUNTST		EQU	RCUNT+1		;
ENDFL		EQU	CUNTST+1	; 
t_flg		equ	ENDFL+1		; timming flag
r_data		equ	t_flg+1		; R REG DATA
SDFL		EQU	r_data+1	; PRIORITY FLAG.
seflag		EQU	SDFL+1		; song = 0/ s.e = 1 / back_se = 80h

